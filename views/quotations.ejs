<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Êä•‰ª∑ÁÆ°ÁêÜ - DHL ÂõûÈÇÆÂçïÁ≥ªÁªü</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    .quotations-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .quotations-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .quotations-header h1 {
      font-size: 28px;
      color: #333;
      margin: 0;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
    }

    .tab {
      padding: 12px 24px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
    }

    .tab.active {
      color: #0066cc;
      border-bottom-color: #0066cc;
    }

    .tab:hover {
      color: #333;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .quotation-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .quotation-card {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
      background: white;
      transition: all 0.3s ease;
    }

    .quotation-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .quotation-card.default {
      border: 2px solid #0066cc;
      background: #f0f7ff;
    }

    .quotation-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 15px;
    }

    .quotation-title {
      font-size: 18px;
      font-weight: 700;
      color: #333;
    }

    .quotation-badge {
      display: inline-block;
      padding: 4px 12px;
      background: #0066cc;
      color: white;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .quotation-price {
      font-size: 32px;
      font-weight: 700;
      color: #0066cc;
      margin-bottom: 10px;
    }

    .quotation-currency {
      font-size: 14px;
      color: #666;
    }

    .quotation-description {
      font-size: 14px;
      color: #666;
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .quotation-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      flex: 1;
      min-width: 100px;
    }

    .btn-primary {
      background: #0066cc;
      color: white;
    }

    .btn-primary:hover {
      background: #0052a3;
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    .btn-success {
      background: #4caf50;
      color: white;
    }

    .btn-success:hover {
      background: #45a049;
    }

    .btn-danger {
      background: #f44336;
      color: white;
    }

    .btn-danger:hover {
      background: #da190b;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
      flex: none;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.4);
      overflow-y: auto;
    }

    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background-color: #fefefe;
      padding: 30px;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }

    .modal-header {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 20px;
      color: #333;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #333;
      font-size: 14px;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      font-family: inherit;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .form-group input[type="checkbox"] {
      width: auto;
      margin-right: 8px;
    }

    .form-group-inline {
      display: flex;
      align-items: center;
    }

    .form-group-inline label {
      margin-bottom: 0;
      margin-right: 10px;
    }

    .form-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .form-actions button {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
    }

    .customer-list {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 15px;
    }

    .customer-item {
      padding: 12px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .customer-item:last-child {
      border-bottom: none;
    }

    .customer-item:hover {
      background: #f9f9f9;
    }

    .customer-info {
      flex: 1;
    }

    .customer-name {
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
    }

    .customer-price {
      font-size: 14px;
      color: #0066cc;
      font-weight: 600;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    @media (max-width: 768px) {
      .quotation-grid {
        grid-template-columns: 1fr;
      }

      .quotation-actions {
        flex-direction: column;
      }

      .quotation-actions .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <%- include('partials/header') %>

  <div class="quotations-container">
    <div class="quotations-header">
      <h1>üíµ Êä•‰ª∑ÁÆ°ÁêÜ</h1>
      <div>
        <button class="btn btn-primary" onclick="location.href='/dashboard'">ËøîÂõû‰ª™Ë°®Êùø</button>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('standard')">Ê†áÂáÜÊä•‰ª∑</button>
      <button class="tab" onclick="switchTab('custom')">ÂÆ¢Êà∑ÂÆöÂà∂Êä•‰ª∑</button>
    </div>

    <!-- Ê†áÂáÜÊä•‰ª∑Ê†áÁ≠æÈ°µ -->
    <div id="standard" class="tab-content active">
      <div style="margin-bottom: 20px;">
        <button class="btn btn-success" onclick="openAddQuotationModal()">+ Êñ∞Â¢ûÊä•‰ª∑</button>
      </div>

      <div class="quotation-grid" id="quotationGrid">
        <div class="empty-state">Âä†ËΩΩ‰∏≠...</div>
      </div>
    </div>

    <!-- ÂÆ¢Êà∑ÂÆöÂà∂Êä•‰ª∑Ê†áÁ≠æÈ°µ -->
    <div id="custom" class="tab-content">
      <div style="margin-bottom: 20px;">
        <button class="btn btn-success" onclick="openCopyQuotationModal()">+ Â§çÂà∂Êä•‰ª∑ÁªôÂÆ¢Êà∑</button>
      </div>

      <div id="customQuotationsList" class="quotation-grid">
        <div class="empty-state">Âä†ËΩΩ‰∏≠...</div>
      </div>
    </div>
  </div>

  <!-- Êñ∞Â¢ûÊä•‰ª∑Ê®°ÊÄÅÊ°Ü -->
  <div id="addQuotationModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">Êñ∞Â¢ûÊä•‰ª∑</div>
      <form onsubmit="submitAddQuotation(event)">
        <div class="form-group">
          <label>Êä•‰ª∑ÂêçÁß∞</label>
          <input type="text" id="quotationName" required>
        </div>
        <div class="form-group">
          <label>Êä•‰ª∑ÊèèËø∞</label>
          <textarea id="quotationDescription"></textarea>
        </div>
        <div class="form-group">
          <label>‰ª∑Ê†º (EUR)</label>
          <input type="number" id="quotationPrice" step="0.01" required>
        </div>
        <div class="form-group form-group-inline">
          <input type="checkbox" id="quotationDefault">
          <label>ËÆæ‰∏∫ÈªòËÆ§Êä•‰ª∑</label>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">ÂàõÂª∫</button>
          <button type="button" class="btn btn-secondary" onclick="closeAddQuotationModal()">ÂèñÊ∂à</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Â§çÂà∂Êä•‰ª∑Ê®°ÊÄÅÊ°Ü -->
  <div id="copyQuotationModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">Â§çÂà∂Êä•‰ª∑ÁªôÂÆ¢Êà∑</div>
      <form onsubmit="submitCopyQuotation(event)">
        <div class="form-group">
          <label>ÈÄâÊã©Êä•‰ª∑</label>
          <select id="quotationSelect" required onchange="loadQuotationDetails()">
            <option value="">-- ÈÄâÊã©Êä•‰ª∑ --</option>
          </select>
        </div>
        <div class="form-group">
          <label>ÂÆöÂà∂‰ª∑Ê†º (ÂèØÈÄâ)</label>
          <input type="number" id="customPrice" step="0.01" placeholder="‰∏çÂ°´Âàô‰ΩøÁî®Âéü‰ª∑">
        </div>
        <div class="form-group">
          <label>ÈÄâÊã©ÂÆ¢Êà∑</label>
          <div class="customer-list" id="customerList"></div>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Â§çÂà∂</button>
          <button type="button" class="btn btn-secondary" onclick="closeCopyQuotationModal()">ÂèñÊ∂à</button>
        </div>
      </form>
    </div>
  </div>

  <%- include('partials/footer') %>

  <script>
    let selectedCustomerId = null;

    function switchTab(tabName) {
      // ÈöêËóèÊâÄÊúâÊ†áÁ≠æÈ°µ
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));

      // ÊòæÁ§∫ÈÄâ‰∏≠ÁöÑÊ†áÁ≠æÈ°µ
      document.getElementById(tabName).classList.add('active');
      event.target.classList.add('active');

      if (tabName === 'standard') {
        loadQuotations();
      } else {
        loadCustomQuotations();
      }
    }

    async function loadQuotations() {
      try {
        const response = await fetch('/api/quotations/list');
        const result = await response.json();

        if (result.ok) {
          renderQuotations(result.data);
        }
      } catch (err) {
        console.error('Âä†ËΩΩÊä•‰ª∑Â§±Ë¥•:', err);
      }
    }

    function renderQuotations(data) {
      const grid = document.getElementById('quotationGrid');

      if (data.length === 0) {
        grid.innerHTML = '<div class="empty-state">ÊöÇÊó†Êä•‰ª∑</div>';
        return;
      }

      grid.innerHTML = data.map(q => `
        <div class="quotation-card ${q.is_default ? 'default' : ''}">
          <div class="quotation-header">
            <div class="quotation-title">${q.name}</div>
            ${q.is_default ? '<span class="quotation-badge">ÈªòËÆ§</span>' : ''}
          </div>
          <div class="quotation-price">‚Ç¨${q.price.toFixed(2)}</div>
          ${q.description ? `<div class="quotation-description">${q.description}</div>` : ''}
          <div class="quotation-actions">
            <button class="btn btn-primary btn-small" onclick="editQuotation(${q.id})">ÁºñËæë</button>
            <button class="btn btn-success btn-small" onclick="copyQuotationForCustomer(${q.id})">Â§çÂà∂</button>
            <button class="btn btn-danger btn-small" onclick="deleteQuotation(${q.id})">Âà†Èô§</button>
          </div>
        </div>
      `).join('');
    }

    async function loadCustomQuotations() {
      try {
        const response = await fetch('/api/quotations/all/custom');
        const result = await response.json();

        if (result.ok) {
          renderCustomQuotations(result.data);
        }
      } catch (err) {
        console.error('Âä†ËΩΩÂÆ¢Êà∑ÂÆöÂà∂Êä•‰ª∑Â§±Ë¥•:', err);
      }
    }

    function renderCustomQuotations(data) {
      const container = document.getElementById('customQuotationsList');

      if (data.length === 0) {
        container.innerHTML = '<div class="empty-state">ÊöÇÊó†ÂÆöÂà∂Êä•‰ª∑</div>';
        return;
      }

      // ÊåâÂÆ¢Êà∑ÂàÜÁªÑ
      const grouped = {};
      data.forEach(item => {
        if (!grouped[item.customer_id]) {
          grouped[item.customer_id] = {
            customer_name: item.customer_name,
            quotations: []
          };
        }
        grouped[item.customer_id].quotations.push(item);
      });

      container.innerHTML = Object.entries(grouped).map(([customerId, group]) => `
        <div style="grid-column: 1 / -1; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; background: white;">
          <h3 style="margin-top: 0; color: #333;">${group.customer_name}</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
            ${group.quotations.map(q => `
              <div style="border: 1px solid #e0e0e0; border-radius: 4px; padding: 15px; background: #f9f9f9;">
                <div style="font-weight: 600; color: #333; margin-bottom: 8px;">${q.quotation_name}</div>
                <div style="font-size: 20px; color: #0066cc; font-weight: 700; margin-bottom: 8px;">
                  ‚Ç¨${q.final_price.toFixed(2)}
                </div>
                ${q.custom_price ? `<div style="font-size: 12px; color: #666;">Âéü‰ª∑: ‚Ç¨${q.base_price.toFixed(2)}</div>` : ''}
              </div>
            `).join('')}
          </div>
        </div>
      `).join('');
    }

    function openAddQuotationModal() {
      document.getElementById('addQuotationModal').classList.add('show');
    }

    function closeAddQuotationModal() {
      document.getElementById('addQuotationModal').classList.remove('show');
    }

    async function submitAddQuotation(event) {
      event.preventDefault();

      const name = document.getElementById('quotationName').value;
      const description = document.getElementById('quotationDescription').value;
      const price = document.getElementById('quotationPrice').value;
      const isDefault = document.getElementById('quotationDefault').checked;

      try {
        const response = await fetch('/api/quotations/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, description, price, is_default: isDefault })
        });

        const result = await response.json();

        if (result.ok) {
          alert('Êä•‰ª∑Â∑≤ÂàõÂª∫');
          closeAddQuotationModal();
          loadQuotations();
        }
      } catch (err) {
        console.error('ÂàõÂª∫Êä•‰ª∑Â§±Ë¥•:', err);
      }
    }

    function openCopyQuotationModal() {
      loadQuotationOptions();
      loadCustomerOptions();
      document.getElementById('copyQuotationModal').classList.add('show');
    }

    function closeCopyQuotationModal() {
      document.getElementById('copyQuotationModal').classList.remove('show');
    }

    async function loadQuotationOptions() {
      try {
        const response = await fetch('/api/quotations/list');
        const result = await response.json();

        if (result.ok) {
          const select = document.getElementById('quotationSelect');
          select.innerHTML = '<option value="">-- ÈÄâÊã©Êä•‰ª∑ --</option>' +
            result.data.map(q => `<option value="${q.id}">${q.name} (‚Ç¨${q.price.toFixed(2)})</option>`).join('');
        }
      } catch (err) {
        console.error('Âä†ËΩΩÊä•‰ª∑ÈÄâÈ°πÂ§±Ë¥•:', err);
      }
    }

    async function loadCustomerOptions() {
      try {
        const response = await fetch('/api/customers/list');
        const result = await response.json();

        if (result.ok) {
          const list = document.getElementById('customerList');
          list.innerHTML = result.data.map(c => `
            <div class="customer-item" onclick="selectCustomer(${c.id}, '${c.name}')">
              <div class="customer-info">
                <div class="customer-name">${c.name}</div>
              </div>
              <input type="radio" name="customer" value="${c.id}">
            </div>
          `).join('');
        }
      } catch (err) {
        console.error('Âä†ËΩΩÂÆ¢Êà∑ÂàóË°®Â§±Ë¥•:', err);
      }
    }

    function selectCustomer(customerId, customerName) {
      selectedCustomerId = customerId;
      document.querySelector(`input[value="${customerId}"]`).checked = true;
    }

    function loadQuotationDetails() {
      const quotationId = document.getElementById('quotationSelect').value;
      if (quotationId) {
        fetch(`/api/quotations/${quotationId}`)
          .then(r => r.json())
          .then(result => {
            if (result.ok) {
              document.getElementById('customPrice').placeholder = `Âéü‰ª∑: ‚Ç¨${result.data.price.toFixed(2)}`;
            }
          });
      }
    }

    async function submitCopyQuotation(event) {
      event.preventDefault();

      if (!selectedCustomerId) {
        alert('ËØ∑ÈÄâÊã©ÂÆ¢Êà∑');
        return;
      }

      const quotationId = document.getElementById('quotationSelect').value;
      const customPrice = document.getElementById('customPrice').value || null;

      try {
        const response = await fetch('/api/quotations/copy-to-customer', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            quotation_id: quotationId,
            customer_id: selectedCustomerId,
            custom_price: customPrice
          })
        });

        const result = await response.json();

        if (result.ok) {
          alert('Êä•‰ª∑Â∑≤Â§çÂà∂');
          closeCopyQuotationModal();
          loadCustomQuotations();
        }
      } catch (err) {
        console.error('Â§çÂà∂Êä•‰ª∑Â§±Ë¥•:', err);
      }
    }

    function copyQuotationForCustomer(quotationId) {
      document.getElementById('quotationSelect').value = quotationId;
      openCopyQuotationModal();
    }

    async function deleteQuotation(quotationId) {
      if (!confirm('Á°ÆËÆ§Âà†Èô§Ê≠§Êä•‰ª∑ÂêóÔºü')) return;

      try {
        const response = await fetch(`/api/quotations/${quotationId}`, { method: 'DELETE' });
        const result = await response.json();

        if (result.ok) {
          alert('Êä•‰ª∑Â∑≤Âà†Èô§');
          loadQuotations();
        }
      } catch (err) {
        console.error('Âà†Èô§Êä•‰ª∑Â§±Ë¥•:', err);
      }
    }

    function editQuotation(quotationId) {
      alert('ÁºñËæëÂäüËÉΩÂºÄÂèë‰∏≠');
    }

    // È°µÈù¢Âä†ËΩΩÊó∂Ëé∑ÂèñÊï∞ÊçÆ
    loadQuotations();

    // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
    window.onclick = function(event) {
      const addModal = document.getElementById('addQuotationModal');
      const copyModal = document.getElementById('copyQuotationModal');

      if (event.target === addModal) {
        closeAddQuotationModal();
      }
      if (event.target === copyModal) {
        closeCopyQuotationModal();
      }
    }
  </script>
</body>
</html>
