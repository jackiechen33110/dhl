<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è½¨è¿¹è¿½è¸ª - DHL å›é‚®å•ç³»ç»Ÿ</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    .tracking-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .tracking-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .tracking-header h1 {
      font-size: 28px;
      color: #333;
      margin: 0;
    }

    .filter-section {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filter-section select,
    .filter-section input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    .tracking-list {
      display: grid;
      gap: 15px;
    }

    .tracking-item {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
      background: #fff;
      transition: all 0.3s ease;
    }

    .tracking-item:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .tracking-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      border-bottom: 1px solid #f0f0f0;
      padding-bottom: 10px;
    }

    .tracking-item-title {
      font-weight: 600;
      color: #333;
      font-size: 16px;
    }

    .tracking-status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-pending { background: #fff3cd; color: #856404; }
    .status-in_transit { background: #cfe2ff; color: #084298; }
    .status-delivered { background: #d1e7dd; color: #0f5132; }
    .status-returned { background: #f8d7da; color: #842029; }
    .status-lost { background: #f5c2c7; color: #842029; }

    .tracking-item-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }

    .info-field {
      display: flex;
      flex-direction: column;
    }

    .info-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .info-value {
      font-size: 14px;
      color: #333;
    }

    .tracking-timeline {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #f0f0f0;
    }

    .timeline-item {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      position: relative;
      padding-left: 30px;
    }

    .timeline-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 5px;
      width: 12px;
      height: 12px;
      background: #0066cc;
      border-radius: 50%;
      border: 3px solid #fff;
      box-shadow: 0 0 0 2px #0066cc;
    }

    .timeline-content {
      flex: 1;
    }

    .timeline-time {
      font-size: 12px;
      color: #999;
      margin-bottom: 4px;
    }

    .timeline-desc {
      font-size: 14px;
      color: #333;
      margin-bottom: 4px;
    }

    .timeline-location {
      font-size: 12px;
      color: #666;
    }

    .settlement-info {
      background: #f9f9f9;
      border-left: 4px solid #ff9800;
      padding: 12px;
      margin-top: 15px;
      border-radius: 4px;
    }

    .settlement-info.refunded {
      border-left-color: #4caf50;
      background: #f1f8f4;
    }

    .settlement-info.no-tracking {
      border-left-color: #f44336;
      background: #fef5f5;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: #0066cc;
      color: white;
    }

    .btn-primary:hover {
      background: #0052a3;
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    .btn-danger {
      background: #f44336;
      color: white;
    }

    .btn-danger:hover {
      background: #da190b;
    }

    .pagination {
      display: flex;
      justify-content: center;
      gap: 5px;
      margin-top: 30px;
    }

    .pagination a,
    .pagination span {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    .pagination a:hover {
      background: #f0f0f0;
    }

    .pagination .active {
      background: #0066cc;
      color: white;
      border-color: #0066cc;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      .tracking-item-info {
        grid-template-columns: 1fr;
      }

      .action-buttons {
        flex-direction: column;
      }

      .filter-section {
        flex-direction: column;
      }

      .filter-section select,
      .filter-section input {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <%- include('partials/header') %>

  <div class="tracking-container">
    <div class="tracking-header">
      <h1>ğŸ“¦ è½¨è¿¹è¿½è¸ª</h1>
      <div>
        <button class="btn btn-primary" onclick="location.href='/dashboard'">è¿”å›ä»ªè¡¨æ¿</button>
      </div>
    </div>

    <div class="filter-section">
      <select id="statusFilter" onchange="filterTracking()">
        <option value="">æ‰€æœ‰çŠ¶æ€</option>
        <option value="pending">å¾…å‘é€</option>
        <option value="in_transit">è¿è¾“ä¸­</option>
        <option value="delivered">å·²é€è¾¾</option>
        <option value="returned">å·²é€€å›</option>
        <option value="lost">å·²ä¸¢å¤±</option>
      </select>

      <select id="settlementFilter" onchange="filterTracking()">
        <option value="">æ‰€æœ‰ç»“ç®—çŠ¶æ€</option>
        <option value="tracking">è¿½è¸ªä¸­</option>
        <option value="no_tracking">æ— è½¨è¿¹</option>
        <option value="refunded">å·²é€€æ¬¾</option>
      </select>

      <input type="text" id="searchInput" placeholder="æœç´¢è®¢å•å·æˆ–è¿½è¸ªå·..." onkeyup="filterTracking()">
    </div>

    <div id="trackingList" class="tracking-list">
      <!-- è½¨è¿¹åˆ—è¡¨å°†é€šè¿‡ JavaScript åŠ è½½ -->
    </div>

    <div class="pagination" id="pagination"></div>
  </div>

  <%- include('partials/footer') %>

  <script>
    let currentPage = 1;
    const itemsPerPage = 20;

    async function loadTracking(page = 1) {
      try {
        const status = document.getElementById('statusFilter').value;
        const settlement = document.getElementById('settlementFilter').value;
        const search = document.getElementById('searchInput').value;

        const params = new URLSearchParams({
          page,
          limit: itemsPerPage,
          status: status || undefined,
          settlement: settlement || undefined,
          search: search || undefined
        });

        const response = await fetch(`/api/tracking/list?${params}`);
        const result = await response.json();

        if (result.ok) {
          renderTrackingList(result.data);
          renderPagination(result.pagination);
        }
      } catch (err) {
        console.error('åŠ è½½è½¨è¿¹å¤±è´¥:', err);
        document.getElementById('trackingList').innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
      }
    }

    function renderTrackingList(data) {
      const container = document.getElementById('trackingList');

      if (data.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“­</div>
            <p>æš‚æ— è½¨è¿¹æ•°æ®</p>
          </div>
        `;
        return;
      }

      container.innerHTML = data.map(item => `
        <div class="tracking-item">
          <div class="tracking-item-header">
            <div class="tracking-item-title">è®¢å•: ${item.order_no || 'æœªçŸ¥'}</div>
            <span class="tracking-status status-${item.tracking_status || 'pending'}">
              ${getStatusText(item.tracking_status)}
            </span>
          </div>

          <div class="tracking-item-info">
            <div class="info-field">
              <span class="info-label">å®¢æˆ·</span>
              <span class="info-value">${item.customer_name || 'æœªçŸ¥'}</span>
            </div>
            <div class="info-field">
              <span class="info-label">è¿½è¸ªå·</span>
              <span class="info-value">${item.dhl_tracking_no || 'æœªåˆ†é…'}</span>
            </div>
            <div class="info-field">
              <span class="info-label">ç›®çš„åœ°</span>
              <span class="info-value">${item.country || 'æœªçŸ¥'}</span>
            </div>
            <div class="info-field">
              <span class="info-label">æœ€åæ›´æ–°</span>
              <span class="info-value">${formatDate(item.timestamp)}</span>
            </div>
          </div>

          ${item.settlement_status ? `
            <div class="settlement-info ${item.settlement_status}">
              <strong>ç»“ç®—çŠ¶æ€:</strong> ${getSettlementText(item.settlement_status)}
              ${item.settlement_status === 'no_tracking' ? `<br><small>æ— è½¨è¿¹å¤©æ•°: ${item.no_tracking_days || 0}</small>` : ''}
            </div>
          ` : ''}

          <div class="action-buttons">
            <button class="btn btn-primary" onclick="viewDetails(${item.id})">æŸ¥çœ‹è¯¦æƒ…</button>
            <button class="btn btn-secondary" onclick="addTracking(${item.id})">æ·»åŠ è½¨è¿¹</button>
          </div>
        </div>
      `).join('');
    }

    function renderPagination(pagination) {
      const container = document.getElementById('pagination');
      let html = '';

      if (pagination.page > 1) {
        html += `<a onclick="loadTracking(${pagination.page - 1})">â† ä¸Šä¸€é¡µ</a>`;
      }

      for (let i = 1; i <= pagination.pages; i++) {
        if (i === pagination.page) {
          html += `<span class="active">${i}</span>`;
        } else if (i <= 5 || i > pagination.pages - 5 || Math.abs(i - pagination.page) <= 2) {
          html += `<a onclick="loadTracking(${i})">${i}</a>`;
        } else if (i === 6) {
          html += `<span>...</span>`;
        }
      }

      if (pagination.page < pagination.pages) {
        html += `<a onclick="loadTracking(${pagination.page + 1})">ä¸‹ä¸€é¡µ â†’</a>`;
      }

      container.innerHTML = html;
    }

    function getStatusText(status) {
      const texts = {
        'pending': 'å¾…å‘é€',
        'in_transit': 'è¿è¾“ä¸­',
        'delivered': 'å·²é€è¾¾',
        'returned': 'å·²é€€å›',
        'lost': 'å·²ä¸¢å¤±'
      };
      return texts[status] || 'æœªçŸ¥';
    }

    function getSettlementText(status) {
      const texts = {
        'tracking': 'è¿½è¸ªä¸­',
        'no_tracking': 'æ— è½¨è¿¹',
        'refunded': 'å·²é€€æ¬¾'
      };
      return texts[status] || 'æœªçŸ¥';
    }

    function formatDate(date) {
      if (!date) return 'æœªçŸ¥';
      return new Date(date).toLocaleString('zh-CN');
    }

    function filterTracking() {
      currentPage = 1;
      loadTracking(1);
    }

    function viewDetails(shipmentId) {
      window.location.href = `/shipments/detail/${shipmentId}`;
    }

    function addTracking(shipmentId) {
      const location = prompt('è¯·è¾“å…¥ä½ç½®ä¿¡æ¯:');
      const description = prompt('è¯·è¾“å…¥è½¨è¿¹æè¿°:');
      
      if (location && description) {
        fetch('/api/tracking/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            shipment_id: shipmentId,
            status: 'in_transit',
            location,
            description
          })
        }).then(r => r.json()).then(result => {
          if (result.ok) {
            alert('è½¨è¿¹å·²æ·»åŠ ');
            loadTracking(currentPage);
          }
        });
      }
    }

    // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
    loadTracking(1);
  </script>
</body>
</html>
